# バックエンドPRD

## 1. 目的・背景

- **目的**：学習記録アプリのAI機能を提供するマイクロサービスとして、学習プラン生成・分析機能を実装
- **背景**：
  - Next.js/PandaCSSでフロント設計済み
  - Supabaseで学習記録CRUD・認証・ゲーム機能を実装済み
  - Python+FastAPIでAI関連機能のみを実装予定

## 2. 想定ユーザー

- 学習記録アプリのフロントエンド（Next.js）
- Supabaseから学習データを取得してAI分析を依頼するシステム

## 3. 課題

- 学習データを基にした効果的な学習プラン生成が必要
- 学習進捗の分析・アドバイス機能が不足
- AI機能のスケーラブルなAPI提供が必要

## 4. 解決策

- FastAPIでAI専用のRESTfulエンドポイントを実装
- LLM（Gemini 2.0 Flash-Lite無料枠）を活用した学習プラン生成
- 学習データ分析・進捗アドバイス機能の提供
- 今日のTODOリスト自動生成機能の提供
- Supabaseとの連携による学習履歴の取得・分析

## 5. 機能要件

| 機能                 | Must (PoC)                                 | Nice-to-have                       |
|:--------------------|:-------------------------------------------|:-----------------------------------|
| 学習プラン生成      | POST `/api/ai/plan` → JSON返却           | プラン編集履歴、複数パターン生成   |
| 今日のTODO提案      | POST `/api/ai/todo` → TODOリスト返却     | 優先度付け、時間見積もり          |
| 学習進捗分析        | POST `/api/ai/analysis` → 分析結果返却   | 詳細な弱点分析、改善提案          |
| 学習アドバイス      | POST `/api/ai/advice` → アドバイス返却   | パーソナライズ、学習スタイル分析   |
| 学習目標設定支援    | POST `/api/ai/goals` → 目標提案返却      | SMART目標、達成度予測             |

## 6. 非機能要件

- **パフォーマンス**：各AI API応答 ≤ 5秒（LLM処理時間含む）
- **認証**：API キー認証（Supabaseからの呼び出し専用）
- **セキュリティ**：
  - CORS制限＋API Key認証
  - レート制限（1分間100リクエスト）
- **テスト**：Pytest＋HTTPX でユニット／統合テスト

## 7. KPI／検証指標

- AIプラン生成API平均応答 ≤ 5秒
- AI分析API精度 ≥ 85%（ユーザー満足度）
- テストカバレッジ ≥ 80%

## 8. API設計例
POST   /api/ai/plan        # 学習プラン生成
POST   /api/ai/todo        # 今日のTODOリスト提案
POST   /api/ai/analysis    # 学習進捗分析
POST   /api/ai/advice      # 学習アドバイス
POST   /api/ai/goals       # 学習目標設定支援
GET    /api/health         # ヘルスチェック


## 9. データ連携 (Supabaseとの協調)

| データソース      | 取得方法                                 | 用途                                |
|:-----------------|:-----------------------------------------|:------------------------------------|
| records (学習記録)| Supabase REST API経由で取得             | プラン生成・進捗分析の基礎データ    |
| users (ユーザー情報)| 必要に応じてSupabase APIから取得      | パーソナライズ分析                 |
| 生成結果         | FastAPI内で処理・Supabaseに保存しない | フロントに直接返却                  |

**注意**: FastAPIはAI処理に特化し、データの永続化はSupabaseに委譲

## 10. 技術スタック

- **AI機能**：Python 3.10+, FastAPI
- **LLM**：Google Gemini 2.0 Flash-Lite（無料枠）
- **外部連携**：Supabase REST API（学習データ取得）
- **デプロイ**：Railway / Google Cloud Run
- **CI/CD**：GitHub Actions (Lint → テスト → デプロイ)

## 11. 開発スケジュール

| Day | タスク                                                        |
|:----|:-------------------------------------------------------------|
| 1   | リポジトリ初期化、FastAPI基盤構築、Gemini API連携設定         |
| 2   | Supabase連携設定＆学習データ取得API実装                       |
| 3   | 学習プラン生成API実装＆テスト                                 |
| 4   | 今日のTODOリスト提案API実装＆テスト                          |
| 5   | 学習進捗分析API＆アドバイスAPI実装                           |
| 6   | 学習目標設定支援API実装＆統合テスト                          |
| 7   | エラーハンドリング強化・ドキュメント整備・デプロイ           |

## 12. 今日のTODO提案機能 詳細仕様

### 入力データ
- 学習履歴（過去1週間〜1ヶ月）
- 学習目標・計画
- 現在の曜日・時間
- ユーザーの学習スタイル設定（もしあれば）

### 出力形式
```json
{
  "date": "2025-07-12",
  "todos": [
    {
      "id": 1,
      "title": "数学 - 微分の復習",
      "description": "昨日の理解度が70%だったので復習推奨",
      "priority": "high",
      "estimated_time": 30,
      "category": "復習",
      "reason": "理解度向上のため"
    },
    {
      "id": 2,
      "title": "英語 - 新単語学習",
      "description": "週間目標達成のため20個の新単語",
      "priority": "medium",
      "estimated_time": 20,
      "category": "新規学習",
      "reason": "週間目標達成のため"
    }
  ],
  "total_estimated_time": 50,
  "motivational_message": "今日も頑張りましょう！昨日より少し進歩すれば十分です。"
}
```

### AI判断ロジック
1. **継続性重視**: 前日の学習を踏まえた連続性
2. **弱点補強**: 理解度の低い分野を優先
3. **目標達成**: 設定した週間・月間目標への進捗
4. **バランス**: 複数科目のバランス良い配分
5. **現実的な時間配分**: ユーザーの平均学習時間を考慮