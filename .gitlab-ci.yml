stages:
  - test
  - deploy

variables:
  DOCKER_IMAGE_NAME: "choibenassist-backend"
  DOCKER_HOST: unix:///var/run/docker.sock

# Test stage - Dockerå†…ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test:
  stage: test
  tags:
    - shell
  script:
    - echo "ðŸ§ª Running tests in Docker..."
    - |
      # äº‹å‰ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      docker system prune -f --volumes
      
      # ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
      cat > .env.test << EOF
      GEMINI_API_KEY=${GEMINI_API_KEY}
      SUPABASE_URL=${SUPABASE_URL}
      SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      API_SECRET_KEY=${API_SECRET_KEY}
      DEBUG=True
      ENVIRONMENT=test
      EOF
    - |
      # Dockerã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      docker system prune -f
      docker build --no-cache -t ${DOCKER_IMAGE_NAME}:test .
      docker run --rm --env-file .env.test ${DOCKER_IMAGE_NAME}:test sh -c "
        pip install --no-cache-dir -r requirements-dev.txt &&
        pytest tests/ -v &&
        black --check app/ tests/
      "
      docker rmi ${DOCKER_IMAGE_NAME}:test
    - echo "âœ… Tests completed!"
  only:
    - main

# Deploy stage - æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
deploy:
  stage: deploy
  tags:
    - shell
  script:
    - echo "Deploying to production..."
    - |
      # æœ¬ç•ªç”¨ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
      cat > .env.production << EOF
      GEMINI_API_KEY=${GEMINI_API_KEY}
      SUPABASE_URL=${SUPABASE_URL}
      SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      API_SECRET_KEY=${API_SECRET_KEY}
      DEBUG=False
      ENVIRONMENT=production
      EOF
    - |
      # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
      docker system prune -f
      docker build --no-cache -t ${DOCKER_IMAGE_NAME}:production .
      
      # æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ãƒ»å‰Šé™¤
      docker stop choibenassist-production || true
      docker rm -f choibenassist-production || true
      
      # æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
      docker run -d \
        --name choibenassist-production \
        --restart always \
        -p 8000:8000 \
        --env-file .env.production \
        ${DOCKER_IMAGE_NAME}:production
    - |
      # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      echo "ðŸ¥ Health check..."
      sleep 30
      curl -f http://localhost:8000/api/health
    - echo "âœ… Deployment completed!"
  environment:
    name: production
  only:
    - main
