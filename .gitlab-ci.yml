stages:
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_IMAGE_NAME: "choibenassist-backend"

# Test stage
test:
  stage: test
  image: python:3.13.3
  tags:
    - python 
  before_script:
    - echo "ğŸ”§ Setting up Python environment..."
    - python -m venv .venv
    - source .venv/bin/activate
    - echo "ğŸ“¦ Installing dependencies..."
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install -r requirements-dev.txt
    - echo "âœ… Dependencies installed successfully"
  script:
    - echo "ğŸ§ª Running tests..."
    - pytest tests/ -v
    - echo "ğŸ¨ Checking code formatting..."
    - black --check app/ tests/
    - echo "âœ… All tests passed!"
  only:
    - main

# Deploy to production (main branch only)
deploy_production:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  tags:
    - docker 
  before_script:
    - echo "ğŸ³ Setting up Docker environment..."
  script:
    - |
      echo "ğŸ³ Starting Docker build and deploy process..."
      
      # Build Docker image
      echo "ğŸ“¦ Building Docker image..."
      docker build -t $DOCKER_IMAGE_NAME:production .
      echo "âœ… Docker image built successfully"

      
      # Run new container
      echo "ğŸš€ Starting new container..."
      docker run -d \
        --name choibenassist-production \
        --restart unless-stopped \
        -p 8000:8000 \
        --env-file .env \
        choibenassist-backend:production
      echo "âœ… New container started successfully"
      
      # Health check
      echo "ğŸ¥ Performing health check..."
      sleep 30
      curl -f http://localhost:8000/api/health
      echo "âœ… Health check passed! Deployment completed successfully ğŸ‰"
  environment:
    name: production
    url: http://$PRODUCTION_SERVER:8000
  only:
    - main
