stages:
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_IMAGE_NAME: "choibenassist-backend"
  DOCKER_HOST: unix:///var/run/docker.sock
  # Common environment variables for all stages
  RATE_LIMIT_PER_MINUTE: "100"

# Test stage
test:
  stage: test
  tags:
    - shell
  before_script:
    - echo "ğŸ”§ Setting up Docker test environment..."
    - echo "ğŸ” Checking required environment variables..."
    - test -n "$GEMINI_API_KEY" || (echo "âŒ GEMINI_API_KEY is not set!" && exit 1)
    - test -n "$SUPABASE_URL" || (echo "âŒ SUPABASE_URL is not set!" && exit 1)
    - test -n "$SUPABASE_ANON_KEY" || (echo "âŒ SUPABASE_ANON_KEY is not set!" && exit 1)
    - test -n "$API_SECRET_KEY" || (echo "âŒ API_SECRET_KEY is not set!" && exit 1)
    - echo "âœ… All required environment variables are set."
    # Create .env file for tests
    - echo "âš™ï¸ Creating test environment file..."
    - |
      cat > .env.test << 'TEST_ENV_EOF'
      GEMINI_API_KEY=${GEMINI_API_KEY}
      SUPABASE_URL=${SUPABASE_URL}
      SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      API_SECRET_KEY=${API_SECRET_KEY}
      DEBUG=True
      ENVIRONMENT=test
      RATE_LIMIT_PER_MINUTE=${RATE_LIMIT_PER_MINUTE}
      TEST_ENV_EOF
    - echo "âœ… Test environment file created"
  script:
    - |
      echo "ğŸ³ Running tests in Docker container..."
      
      # Build test image
      echo "ğŸ“¦ Building test Docker image..."
      docker build -t $DOCKER_IMAGE_NAME:test -f Dockerfile .
      echo "âœ… Test Docker image built successfully"
      
      # Run tests in Docker container
      echo "ğŸ§ª Running tests in Docker container..."
      docker run --rm \
        -v $(pwd):/app \
        -w /app \
        --env-file .env.test \
        $DOCKER_IMAGE_NAME:test \
        sh -c "
          echo 'ğŸ“¦ Installing dev dependencies...' &&
          pip install -r requirements-dev.txt &&
          echo 'ğŸ§ª Running pytest tests...' &&
          pytest tests/ -v &&
          echo 'ğŸ¨ Checking code formatting with black...' &&
          black --check app/ tests/ &&
          echo 'âœ… All tests passed in Docker!'
        "
      
      # Clean up test image
      docker rmi $DOCKER_IMAGE_NAME:test || true
      echo "âœ… Docker tests completed successfully!"
  only:
    - main

# Deploy to production (main branch only)
deploy_production:
  stage: deploy
  tags:
    - shell  # ã¾ãŸã¯ web, backend ãªã©å®Ÿéš›ã®Runnerã®tagã«åˆã‚ã›ã‚‹ 
  before_script:
    - echo "ğŸ³ Setting up Docker environment..."
    - echo "ğŸ” Checking required environment variables..."
    - test -n "$GEMINI_API_KEY" || (echo "âŒ GEMINI_API_KEY is not set!" && exit 1)
    - test -n "$SUPABASE_URL" || (echo "âŒ SUPABASE_URL is not set!" && exit 1)
    - test -n "$SUPABASE_ANON_KEY" || (echo "âŒ SUPABASE_ANON_KEY is not set!" && exit 1)
    - test -n "$API_SECRET_KEY" || (echo "âŒ API_SECRET_KEY is not set!" && exit 1)
    - echo "âœ… All required environment variables are set."
    - echo "ğŸ”§ Initializing Docker..."
    - docker info || (echo "âŒ Docker is not running!" && exit 1)
  script:
    - |
      echo "ğŸ³ Starting Docker build and deploy process..."
      
      # Create production environment file
      echo "âš™ï¸ Creating production environment file..."
      echo "GEMINI_API_KEY=$GEMINI_API_KEY" > .env.production
      echo "SUPABASE_URL=$SUPABASE_URL" >> .env.production
      echo "SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY" >> .env.production
      echo "API_SECRET_KEY=$API_SECRET_KEY" >> .env.production
      echo "DEBUG=False" >> .env.production
      echo "ENVIRONMENT=production" >> .env.production
      echo "RATE_LIMIT_PER_MINUTE=$RATE_LIMIT_PER_MINUTE" >> .env.production
      echo "âœ… Production environment file created"
      
      # Build Docker image using Dockerfile
      echo "ğŸ“¦ Building Docker image using Dockerfile..."
      docker build --no-cache -t $DOCKER_IMAGE_NAME:production -f Dockerfile .
      echo "âœ… Docker image built successfully"

      # Stop existing container forcefully
      echo "ğŸ›‘ Stopping existing container..."
      docker stop choibenassist-production || true
      docker rm -f choibenassist-production || true
      echo "âœ… Old container removed"
      
      # Run new container with production env file
      echo "ğŸš€ Starting new container..."
      docker run -d \
        --name choibenassist-production \
        --restart always \
        -p 8000:8000 \
        --env-file .env.production \
        -v /var/log/choibenassist:/app/logs \
        $DOCKER_IMAGE_NAME:production
      echo "âœ… New container started successfully"
      
      # Verify deployment
      echo "ğŸ” Verifying deployment..."
      docker ps | grep choibenassist-production
      
      # Health check and integration test
      echo "ğŸ¥ Performing health check and integration tests..."
      sleep 30
      
      # Basic health check
      echo "ğŸ” Testing API health endpoint..."
      curl -f http://localhost:8000/api/health || (echo "âŒ Health check failed!" && exit 1)
      echo "âœ… Health check passed!"
      
      # Additional API tests
      echo "ğŸ§ª Running integration tests against deployed container..."
      docker run --rm \
        --network host \
        --env-file .env.production \
        $DOCKER_IMAGE_NAME:production \
        sh -c "
          echo 'ğŸ” Testing API endpoints...' &&
          python -c \"
import requests
import sys
try:
    # Test health endpoint
    response = requests.get('http://localhost:8000/api/health', timeout=10)
    assert response.status_code == 200
    print('âœ… Health endpoint test passed')
    
    # Test root endpoint
    response = requests.get('http://localhost:8000/', timeout=10)
    print(f'ğŸ” Root endpoint status: {response.status_code}')
    
    print('âœ… All integration tests passed!')
except Exception as e:
    print(f'âŒ Integration test failed: {e}')
    sys.exit(1)
          \"
        " || (echo "âŒ Integration tests failed!" && exit 1)
      
      echo "âœ… All tests passed! Deployment completed successfully ğŸ‰"
  environment:
    name: production
    url: http://$PRODUCTION_SERVER:8000
  only:
    - main
