stages:
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_IMAGE_NAME: "choibenassist-backend"
  # Common environment variables for all stages
  RATE_LIMIT_PER_MINUTE: "100"

# Test stage
test:
  stage: test
  image: python:3.13.3
  tags:
    - python 
  before_script:
    - echo "ðŸ”§ Setting up Python environment..."
    - python -m venv .venv
    - source .venv/bin/activate
    - echo "ðŸ“¦ Installing dependencies..."
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install -r requirements-dev.txt
    - echo "âœ… Dependencies installed successfully"
    # Create .env file for tests
    - echo "âš™ï¸ Creating test environment file..."
    - |
      cat > .env << 'TEST_ENV_EOF'
      GEMINI_API_KEY=${GEMINI_API_KEY}
      SUPABASE_URL=${SUPABASE_URL}
      SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      API_SECRET_KEY=${API_SECRET_KEY}
      DEBUG=True
      ENVIRONMENT=test
      RATE_LIMIT_PER_MINUTE=${RATE_LIMIT_PER_MINUTE}
      TEST_ENV_EOF
    - echo "âœ… Test environment file created"
  script:
    - echo "ðŸ§ª Running tests..."
    - pytest tests/ -v
    - echo "ðŸŽ¨ Checking code formatting..."
    - black --check app/ tests/
    - echo "âœ… All tests passed!"
  only:
    - main

# Deploy to production (main branch only)
deploy_production:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_VERIFY: ""
    DOCKER_CERT_PATH: ""
  tags:
    - docker 
  before_script:
    - echo "ðŸ³ Setting up Docker environment..."
  script:
    - |
      echo "ðŸ³ Starting Docker build and deploy process..."
      
      # Build Docker image
      echo "ðŸ“¦ Building Docker image..."
      docker build -t $DOCKER_IMAGE_NAME:production .
      echo "âœ… Docker image built successfully"
      
      # Create .env file from GitLab CI/CD variables
      echo "âš™ï¸ Creating environment file from GitLab variables..."
      cat > .env << 'ENV_EOF'
      GEMINI_API_KEY=${GEMINI_API_KEY}
      SUPABASE_URL=${SUPABASE_URL}
      SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      API_SECRET_KEY=${API_SECRET_KEY}
      DEBUG=False
      ENVIRONMENT=production
      RATE_LIMIT_PER_MINUTE=${RATE_LIMIT_PER_MINUTE}
      ENV_EOF
      echo "âœ… Environment file created"

      # Stop existing container
      echo "ðŸ›‘ Stopping existing container..."
      docker stop choibenassist-production || true
      docker rm choibenassist-production || true
      echo "âœ… Old container removed"
      
      # Run new container
      echo "ðŸš€ Starting new container..."
      docker run -d \
        --name choibenassist-production \
        --restart unless-stopped \
        -p 8000:8000 \
        --env-file .env \
        choibenassist-backend:production
      echo "âœ… New container started successfully"
      
      # Health check
      echo "ðŸ¥ Performing health check..."
      sleep 30
      curl -f http://localhost:8000/api/health
      echo "âœ… Health check passed! Deployment completed successfully ðŸŽ‰"
  environment:
    name: production
    url: http://$PRODUCTION_SERVER:8000
  only:
    - main
